<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="com.spring.DCShop.board.dao.BoardDAO">
 
	 <!-- 1:다 매핑 -->
 	<resultMap id="boardsMap" type="com.spring.DCShop.user.dto.UserDTO">
 		<id property="u_member_id" column="u_member_id"/>
 		<result property="u_nickname" column="u_nickname"/>
 		<collection property="boardDTO" column="u_member_id" resultMap="getBoard"/>
 	</resultMap>
 	
 	<!-- 1:1 매핑 -->
 	<resultMap id="boardMap" type="com.spring.DCShop.user.dto.UserDTO">
 		<id property="u_member_id" column="u_member_id"/>
 		<result property="u_nickname" column="u_nickname"/>
 		<association property="boardDTO" column="u_member_id" resultMap="getBoard"/>
 	</resultMap>
 	
 	<resultMap id="getBoard" type="com.spring.DCShop.board.dto.BoardDTO">
 		<id property="b_num" column="b_num"/>
 		<result property="u_member_id" column="u_member_id"/>
 		<result property="b_title" column="b_title"/>
 		<result property="b_contents" column="b_contents"/>
 		<result property="b_category" column="b_category"/>
 		<result property="b_dateposted" column="b_dateposted"/>
 		<result property="b_updateDate" column="b_updateDate"/>
 		<result property="b_views" column="b_views"/>
 		<result property="b_recommend" column="b_recommend"/>
 		<result property="b_image" column="b_image"/>
 		<result property="b_comments" column="b_comments"/>
 	</resultMap>
 
 	<!-- 게시판 목록 -->
 	<select id="boardListAction" parameterType="java.util.Map" resultMap="boardsMap">
 		SELECT *
		  FROM (SELECT A.*
					 , rownum AS rn 
				  FROM (SELECT b.*
							 , u.u_nickname
							 ,(SELECT COUNT(*)
					 	  		 FROM comment_tbl c
					 	 		WHERE b.b_num = c.b_num) AS b_comments
						FROM user_tbl u, board_tbl b
						WHERE u.u_member_id = b.u_member_id
						ORDER BY b_num DESC) A 
				) 
		 WHERE rn BETWEEN #{start} AND #{end}
 	</select>
 	
 	<!-- 게시글 전체 개수 -->
 	<select id="boardListTotal" resultType="int">
 		SELECT COUNT(*) FROM board_tbl
 	</select>
 	
 	<!-- 게시판 등록 -->
 	<insert id="boardInsertAction" parameterType="com.spring.DCShop.board.dto.BoardDTO">
		INSERT INTO board_tbl (b_num, u_member_id, b_title, b_contents, b_category, b_dateposted, b_updateDate, b_views, b_recommend, b_image)
		VALUES ((SELECT NVL(MAX(b_num)+1,1) FROM board_tbl), #{u_member_id}, #{b_title}, #{b_contents}, #{b_category}, sysdate, NULL, 0, 0, 
			<if test='b_image != null'>
				#{b_image}
			</if>
			<if test='b_image == null'>
				null
			</if>)
 	</insert>
 	
 	<!-- 회원 번호  -->
 	<select id="selectU_member_id" parameterType="String" resultType="int">
 		SELECT u_member_id
 		  FROM user_tbl
 		 where u_id = #{u_id}
 	</select>
 	
 	<!-- 게시글 번호 -->
 	<select id="selectB_num" parameterType="int" resultType="int">
 		SELECT MAX(b_num)
 		  FROM board_tbl
 		 WHERE u_member_id = #{u_member_id}
 	</select>
 	
 	<!-- 게시판 상세페이지 -->
 	<select id="boardDetailAction" parameterType="int" resultMap="boardMap">
 		SELECT b.*
			 , u.u_nickname
		  FROM user_tbl u, board_tbl b
		 WHERE u.u_member_id = b.u_member_id
		   AND b.b_num = #{b_num}
 	</select>
 	
 	<!-- 조회수 증가 -->
 	<update id="viewsUpdateAction" parameterType="int">
 		UPDATE board_tbl
 		   SET b_views = b_views + 1
 		 WHERE b_num = #{b_num}
 	</update>
 	
 	<!-- 추천 여부 -->
 	<select id="isRecommended" parameterType="java.util.Map" resultType="int">
 		SELECT COUNT(*)
 		  FROM recommend_tbl
 		 WHERE u_member_id = #{u_member_id}
 		   AND b_num = #{b_num}
 	</select>
 	
 	<!-- 추천 추가 클릭 -->
 	<insert id="recommendAddAction" parameterType="java.util.Map">
 		INSERT INTO recommend_tbl(rec_num, u_member_id, b_num)
 		VALUES ((SELECT NVL(MAX(rec_num)+1, 1) FROM recommend_tbl), #{u_member_id}, #{b_num})
 	</insert>
 	
 	<!-- 추천 삭제 클릭 -->
 	<delete id="recommendRemoveAction" parameterType="java.util.Map">
 		DELETE FROM recommend_tbl
 		 WHERE b_num = #{b_num}
 		   AND u_member_id = #{u_member_id}
 	</delete>
 	
 	<!-- board_tbl 추천수 변경 -->
 	<update id="recommendUpdateAction" parameterType="java.util.Map" >
 		UPDATE board_tbl
   		   SET b_recommend = ( SELECT COUNT(*)
   		  						 FROM recommend_tbl
   		 						WHERE b_num = #{b_num}
   							  )
 		 WHERE b_num = #{b_num}
 	</update>
 	
 	<!-- 게시글 추천수 -->
 	<select id="selectB_recommend" parameterType="int" resultType="int">
 		SELECT b_recommend
 		  FROM board_tbl
 		 WHERE b_num = #{b_num}
 	</select>
 
  </mapper>